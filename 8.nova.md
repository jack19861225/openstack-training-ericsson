# Nova 模块实践

## Nova api 流程

- create a instance

if the command is : $ nova --debug boot test2 --flavor 1 --image cirros-0.3.4-x86_64-uec --num-instance 1  
```
REQ: curl -g -i -X GET http://192.168.6.131:5000/v2.0 -H "Accept: application/json" -H "User-Agent: keystoneauth1/2.8.0 python-requests/2.10.0 CPython/2.7.6"

REQ: curl -g -i -X GET http://192.168.6.131:8774/v2.1 -H "User-Agent: python-novaclient" -H "Accept: application/json" -H "X-Auth-Token: {SHA1}7743949e9749ec3402ec8befa96d8c1ed918e514"


REQ: curl -g -i -X GET http://192.168.6.131:8774/v2.1/images/5e35d3f2-075d-4990-80d6-251b73da8ba4 -H "User-Agent: python-novaclient" -H "Accept: application/json" -H "X-OpenStack-Nova-API-Version: 2.25" -H "X-Auth-Token: {SHA1}7743949e9749ec3402ec8befa96d8c1ed918e514"

REQ: curl -g -i -X GET http://192.168.6.131:8774/v2.1/flavors/1 -H "User-Agent: python-novaclient" -H "Accept: application/json" -H "X-OpenStack-Nova-API-Version: 2.25" -H "X-Auth-Token: {SHA1}7743949e9749ec3402ec8befa96d8c1ed918e514"

REQ: curl -g -i -X POST http://192.168.6.131:8774/v2.1/servers -H "User-Agent: python-novaclient" -H "Content-Type: application/json" -H "Accept: application/json" -H "X-OpenStack-Nova-API-Version: 2.25" -H "X-Auth-Token: {SHA1}7743949e9749ec3402ec8befa96d8c1ed918e514" -d '{"server": {"min_count": 1, "flavorRef": "1", "name": "test2", "imageRef": "5e35d3f2-075d-4990-80d6-251b73da8ba4", "max_count": 1}}'


REQ: curl -g -i -X GET http://192.168.6.131:8774/v2.1/servers/eccb896a-528f-40f4-bf51-d6e13529a713 -H "User-Agent: python-novaclient" -H "Accept: application/json" -H "X-OpenStack-Nova-API-Version: 2.25" -H "X-Auth-Token: {SHA1}7743949e9749ec3402ec8befa96d8c1ed918e514"
```
```
创建实例接口

这里对应的依然是Controller

具体位置为：nova.api.openstack.compute.servers.Controller.create

注意这个方法的装饰器有一个@wsgi.response(202)，而根据HTTP协议状态码返回202表示服务器已接受请求，但尚未处理，表明这是一个异步任务。

最终此方法调用的self.compute_api.create(...)是由__init__(...)中的self.compute_api = compute.API()获取。

因此compute.API()对应到nova.compute.api.API.create(...)，其内部又调用nova.compute.api.API._create_instance(...) 。

就在nova.compute.api.API._create_instance(...)里面

```

## libvirt, driver.py

driver.py
```
def compare_cpu(self, cpu_info): 
        """Compares given cpu info against host 确保vm能运行  
def finish_migration(self, context, instance, disk_info, network_info,  
#打开一个迁移的实例，完成一个调整  
def suspend(self, instance, callback):  
def rescue(self, context, instance, callback, network_info):  
  #恢复指定的实例
def update_available_resource(self, ctxt, host):
  #在computeNode表中更新电脑资源管理的信息  
def live_migration(self, ctxt, instance_ref, dest,post_method, recover_method)
 分发处理高负荷，当有高负荷操作时候，大量生成 live_mirgration 
def inject_file(self, instance, b64_path, b64_contents):  
        """在指定的实例上写文件  


```

## OpenStack Compute API

